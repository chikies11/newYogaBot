package org.example;

import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.InlineKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.InlineKeyboardButton;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

import java.sql.*;
import java.time.*;
import java.util.*;
import java.util.concurrent.*;

public class YogaBot extends TelegramLongPollingBot {

    private final String BOT_USERNAME;
    private final String BOT_TOKEN;
    private final String ADMIN_ID;
    private final String CHANNEL_ID;
    private final String DB_URL;

    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);

    public YogaBot() {
        BOT_USERNAME = requireEnv("BOT_USERNAME");
        BOT_TOKEN = requireEnv("BOT_TOKEN");
        ADMIN_ID = requireEnv("ADMIN_ID");
        CHANNEL_ID = requireEnv("CHANNEL_ID");
        DB_URL = requireEnv("DATABASE_URL");

        initDb();
        scheduleDailyReminder();
    }

    /** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è */
    private static String requireEnv(String name) {
        String val = System.getenv(name);
        if (val == null || val.isEmpty()) throw new IllegalStateException("Environment variable " + name + " is not set");
        return val;
    }

    /** –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç */
    private void initDb() {
        try (Connection conn = DriverManager.getConnection(DB_URL)) {
            Statement st = conn.createStatement();
            st.executeUpdate("""
                CREATE TABLE IF NOT EXISTS lessons (
                    id SERIAL PRIMARY KEY,
                    datetime TIMESTAMP NOT NULL,
                    title TEXT NOT NULL
                )
            """);
            st.executeUpdate("""
                CREATE TABLE IF NOT EXISTS signups (
                    id SERIAL PRIMARY KEY,
                    lesson_id INT REFERENCES lessons(id) ON DELETE CASCADE,
                    username TEXT NOT NULL
                )
            """);
            st.executeUpdate("""
                CREATE TABLE IF NOT EXISTS subscriptions (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT UNIQUE NOT NULL
                )
            """);
            System.out.println("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.");
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    /** –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 14:00 (–ú–°–ö) */
    private void scheduleDailyReminder() {
        Runnable task = () -> {
            try (Connection conn = DriverManager.getConnection(DB_URL)) {
                PreparedStatement ps = conn.prepareStatement("""
                    SELECT id, datetime, title FROM lessons
                    WHERE datetime >= CURRENT_DATE + 1
                      AND datetime < CURRENT_DATE + 2
                """);
                ResultSet rs = ps.executeQuery();

                while (rs.next()) {
                    int lessonId = rs.getInt("id");
                    Timestamp dt = rs.getTimestamp("datetime");
                    String title = rs.getString("title");

                    String text = "üìÖ –ó–∞–≤—Ç—Ä–∞ –≤ " +
                            dt.toLocalDateTime().toLocalTime() +
                            " ‚Äî " + title;

                    InlineKeyboardButton btn = new InlineKeyboardButton();
                    btn.setText("–ó–∞–ø–∏—Å–∞—Ç—å—Å—è");
                    btn.setCallbackData("signup_" + lessonId);

                    InlineKeyboardMarkup markup = new InlineKeyboardMarkup();
                    markup.setKeyboard(List.of(List.of(btn)));

                    sendMsg(CHANNEL_ID, text, markup);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        };

        ZoneId moscow = ZoneId.of("Europe/Moscow");
        LocalDateTime now = LocalDateTime.now(moscow);
        LocalDateTime next14 = now.withHour(14).withMinute(0).withSecond(0).withNano(0);
        if (now.isAfter(next14)) next14 = next14.plusDays(1);

        long initialDelay = Duration.between(now, next14).toSeconds();
        long oneDay = 24 * 60 * 60;

        scheduler.scheduleAtFixedRate(task, initialDelay, oneDay, TimeUnit.SECONDS);
    }

    @Override
    public String getBotUsername() { return BOT_USERNAME; }

    @Override
    public String getBotToken() { return BOT_TOKEN; }

    @Override
    public void onUpdateReceived(Update update) {
        try {
            if (update.hasMessage() && update.getMessage().hasText()) {
                String chatId = update.getMessage().getChatId().toString();
                String text = update.getMessage().getText();
                Long userId = update.getMessage().getFrom().getId();

                switch (text) {
                    case "/start" -> {
                        sendMsg(chatId, "–ü—Ä–∏–≤–µ—Ç! –Ø YogaBot üßò");
                        sendMainMenu(chatId);
                    }
                    case "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" -> toggleSubscription(chatId, userId);
                    case "üìñ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" -> showSchedule(chatId);
                    case "‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ" -> {
                        if (isAdmin(userId)) sendMsg(chatId, "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –º–µ–Ω—é –∏–∑–º–µ–Ω–µ–Ω–∏—è.");
                        else sendMsg(chatId, "‚õî –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –∑–∞–Ω—è—Ç–∏—è.");
                    }
                    case "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ" -> {
                        if (isAdmin(userId)) sendMsg(chatId, "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–±–æ—Ä –∑–∞–Ω—è—Ç–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã.");
                        else sendMsg(chatId, "‚õî –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞–Ω—è—Ç–∏—è.");
                    }
                    case "üë• –ó–∞–ø–∏—Å–∞–≤—à–∏–µ—Å—è" -> showSignups(chatId);
                }
            }

            if (update.hasCallbackQuery()) {
                String data = update.getCallbackQuery().getData();
                String user = update.getCallbackQuery().getFrom().getUserName();
                Long userId = update.getCallbackQuery().getFrom().getId();
                String chatId = update.getCallbackQuery().getMessage().getChatId().toString();

                if (data.startsWith("signup_")) {
                    int lessonId = Integer.parseInt(data.split("_")[1]);
                    try (Connection conn = DriverManager.getConnection(DB_URL)) {
                        PreparedStatement ps = conn.prepareStatement(
                                "INSERT INTO signups (lesson_id, username) VALUES (?, ?)"
                        );
                        ps.setInt(1, lessonId);
                        ps.setString(2, user != null ? user : userId.toString());
                        ps.executeUpdate();
                        sendMsg(chatId, "‚úÖ –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ!");
                    } catch (SQLException e) {
                        sendMsg(chatId, "‚ö†Ô∏è –í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.");
                    }
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void sendMainMenu(String chatId) {
        SendMessage msg = new SendMessage(chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:");
        InlineKeyboardMarkup markup = new InlineKeyboardMarkup();

        List<List<InlineKeyboardButton>> rows = new ArrayList<>();

        rows.add(List.of(button("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "menu_notify")));
        rows.add(List.of(button("üìñ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ", "menu_schedule")));
        rows.add(List.of(button("üë• –ó–∞–ø–∏—Å–∞–≤—à–∏–µ—Å—è", "menu_signups")));
        rows.add(List.of(button("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ", "menu_edit")));
        rows.add(List.of(button("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ", "menu_cancel")));

        markup.setKeyboard(rows);
        msg.setReplyMarkup(markup);

        sendMsg(msg);
    }

    private InlineKeyboardButton button(String text, String callback) {
        InlineKeyboardButton btn = new InlineKeyboardButton();
        btn.setText(text);
        btn.setCallbackData(callback);
        return btn;
    }

    private void toggleSubscription(String chatId, Long userId) {
        try (Connection conn = DriverManager.getConnection(DB_URL)) {
            PreparedStatement check = conn.prepareStatement("SELECT id FROM subscriptions WHERE user_id=?");
            check.setLong(1, userId);
            ResultSet rs = check.executeQuery();
            if (rs.next()) {
                PreparedStatement del = conn.prepareStatement("DELETE FROM subscriptions WHERE user_id=?");
                del.setLong(1, userId);
                del.executeUpdate();
                sendMsg(chatId, "üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã");
            } else {
                PreparedStatement ins = conn.prepareStatement("INSERT INTO subscriptions (user_id) VALUES (?)");
                ins.setLong(1, userId);
                ins.executeUpdate();
                sendMsg(chatId, "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã");
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void showSchedule(String chatId) {
        try (Connection conn = DriverManager.getConnection(DB_URL)) {
            Statement st = conn.createStatement();
            ResultSet rs = st.executeQuery("SELECT datetime, title FROM lessons ORDER BY datetime");
            StringBuilder sb = new StringBuilder("üìñ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:\n");
            while (rs.next()) {
                sb.append("‚Ä¢ ")
                        .append(rs.getTimestamp("datetime").toLocalDateTime())
                        .append(" ‚Äî ")
                        .append(rs.getString("title"))
                        .append("\n");
            }
            sendMsg(chatId, sb.toString());
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void showSignups(String chatId) {
        try (Connection conn = DriverManager.getConnection(DB_URL)) {
            Statement st = conn.createStatement();
            ResultSet rs = st.executeQuery("""
                SELECT lessons.title, signups.username
                FROM signups
                JOIN lessons ON lessons.id = signups.lesson_id
                ORDER BY lessons.datetime
            """);
            StringBuilder sb = new StringBuilder("üë• –ó–∞–ø–∏—Å–∞–≤—à–∏–µ—Å—è:\n");
            while (rs.next()) {
                sb.append("‚Ä¢ ").append(rs.getString("title"))
                        .append(" ‚Äî @").append(rs.getString("username")).append("\n");
            }
            sendMsg(chatId, sb.toString());
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private boolean isAdmin(Long userId) {
        return ADMIN_ID.equals(userId.toString());
    }

    /** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ä–∏—Å–∫–∞ execute(void) */
    private void sendMsg(String chatId, String text) {
        sendMsg(new SendMessage(chatId, text));
    }

    private void sendMsg(String chatId, String text, InlineKeyboardMarkup markup) {
        SendMessage msg = new SendMessage();
        msg.setChatId(chatId);       // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ String
        msg.setText(text);           // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ String
        msg.setReplyMarkup(markup);  // –µ—Å–ª–∏ markup == null, –≤—Å—ë –æ–∫

        sendMsg(msg);                // –≤—ã–∑—ã–≤–∞–µ–º —Ç–≤–æ—é –æ–±—ë—Ä—Ç–∫—É, –∫–æ—Ç–æ—Ä–∞—è execute()
    }


    private void sendMsg(SendMessage message) {
        try {
            execute(message);
        } catch (TelegramApiException e) {
            e.printStackTrace();
        }
    }
}